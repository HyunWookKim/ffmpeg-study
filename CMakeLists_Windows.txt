# =============================================================================
# FFmpeg í•™ìŠµìš© í”„ë¡œì íŠ¸ - Windows ì „ìš© CMake ì„¤ì • íŒŒì¼
# =============================================================================
# ì´ íŒŒì¼ì€ Windows í™˜ê²½ì—ì„œ wingetìœ¼ë¡œ ì„¤ì¹˜í•œ FFmpegë¥¼ ì‚¬ìš©í•˜ëŠ” ê²½ìš°ì˜ ì„¤ì •ì…ë‹ˆë‹¤.
# ì¼ë°˜ì ì¸ CMakeLists.txtì™€ ë‹¬ë¦¬ ì‹œìŠ¤í…œì— ì„¤ì¹˜ëœ FFmpeg ê²½ë¡œë¥¼ ì§ì ‘ ì§€ì •í•©ë‹ˆë‹¤.

# ìµœì†Œ CMake ë²„ì „ ìš”êµ¬ì‚¬í•­
cmake_minimum_required(VERSION 3.20)

# í”„ë¡œì íŠ¸ ì´ë¦„ ì„¤ì •
project(ffmpeg-study)

# C++ í‘œì¤€ ë²„ì „ ì„¤ì • (C++17 ì‚¬ìš©)
set(CMAKE_CXX_STANDARD 17)
set(CMAKE_CXX_STANDARD_REQUIRED ON)

# =============================================================================
# Windows í™˜ê²½ì—ì„œ wingetìœ¼ë¡œ ì„¤ì¹˜í•œ FFmpeg ì„¤ì •
# =============================================================================
# winget install "FFmpeg (Essentials Build)" ëª…ë ¹ìœ¼ë¡œ ì„¤ì¹˜í•œ FFmpegì˜ ê²½ë¡œì…ë‹ˆë‹¤.

# Windows í™˜ê²½ ì„¤ì •
# ì¤‘ìš”: WIN32ëŠ” Windows 32ë¹„íŠ¸ë§Œì´ ì•„ë‹ˆë¼ ëª¨ë“  Windows(32bit+64bit)ë¥¼ ì˜ë¯¸í•©ë‹ˆë‹¤!
if(WIN32)
    # wingetìœ¼ë¡œ ì„¤ì¹˜ëœ FFmpegì˜ ê¸°ë³¸ ê²½ë¡œ
    # ì‚¬ìš©ìëª…ê³¼ ì„¤ì¹˜ ë²„ì „ì— ë”°ë¼ ê²½ë¡œê°€ ë‹¤ë¥¼ ìˆ˜ ìˆìœ¼ë¯€ë¡œ í™•ì¸ í•„ìš”
    set(FFMPEG_ROOT "C:/Users/wise.kim/AppData/Local/Microsoft/WinGet/Packages/Gyan.FFmpeg_Microsoft.Winget.Source_8wekyb3d8bbwe/ffmpeg-7.1.1-full_build")
    set(FFMPEG_INCLUDE_DIR "${FFMPEG_ROOT}/include")  # í—¤ë” íŒŒì¼ ê²½ë¡œ
    set(FFMPEG_LIB_DIR "${FFMPEG_ROOT}/lib")          # ë¼ì´ë¸ŒëŸ¬ë¦¬ íŒŒì¼ ê²½ë¡œ
    
    # í˜„ì¬ ë¹Œë“œ ì•„í‚¤í…ì²˜ í™•ì¸ ë° í‘œì‹œ
    if(CMAKE_SIZEOF_VOID_P EQUAL 8)
        message(STATUS "ğŸ—ï¸  Windows 64ë¹„íŠ¸ ë¹Œë“œ í™˜ê²½")
        # 64ë¹„íŠ¸ ì „ìš© ë¼ì´ë¸ŒëŸ¬ë¦¬ê°€ ë³„ë„ í´ë”ì— ìˆë‹¤ë©´:
        # set(FFMPEG_LIB_DIR "${FFMPEG_ROOT}/lib/x64")
    else()
        message(STATUS "ğŸ—ï¸  Windows 32ë¹„íŠ¸ ë¹Œë“œ í™˜ê²½")
        # 32ë¹„íŠ¸ ì „ìš© ë¼ì´ë¸ŒëŸ¬ë¦¬ê°€ ë³„ë„ í´ë”ì— ìˆë‹¤ë©´:
        # set(FFMPEG_LIB_DIR "${FFMPEG_ROOT}/lib/x86")
    endif()
    
    # FFmpeg í—¤ë” íŒŒì¼ ë””ë ‰í† ë¦¬ê°€ ì‹¤ì œë¡œ ì¡´ì¬í•˜ëŠ”ì§€ í™•ì¸
    if(EXISTS "${FFMPEG_INCLUDE_DIR}")
        message(STATUS "Found FFmpeg include directory: ${FFMPEG_INCLUDE_DIR}")
    else()
        message(STATUS "FFmpeg include directory not found at: ${FFMPEG_INCLUDE_DIR}")
        # ëŒ€ì•ˆ ê²½ë¡œ í™•ì¸
        if(EXISTS "${FFMPEG_ROOT}/bin")
            # ì‹¤í–‰ íŒŒì¼ë§Œ ìˆëŠ” ì„¤ì¹˜ì¸ ê²½ìš°
            message(STATUS "This appears to be a binary-only FFmpeg installation")
            message(STATUS "You may need to download the dev package with headers and libraries")
        endif()
    endif()
    
    # ì»´íŒŒì¼ëŸ¬ê°€ FFmpeg í—¤ë” íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ìˆë„ë¡ ê²½ë¡œ ì¶”ê°€
    include_directories(${FFMPEG_INCLUDE_DIR})
    # ë§ì»¤ê°€ FFmpeg ë¼ì´ë¸ŒëŸ¬ë¦¬ íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ìˆë„ë¡ ê²½ë¡œ ì¶”ê°€  
    link_directories(${FFMPEG_LIB_DIR})
    
    # Windowsìš© FFmpeg ë¼ì´ë¸ŒëŸ¬ë¦¬ ëª©ë¡
    set(FFMPEG_LIBRARIES
        avformat    # íŒŒì¼ í˜•ì‹ ì²˜ë¦¬ (MP4, AVI ë“±)
        avcodec     # ì½”ë± ì²˜ë¦¬ (H.264, HEVC ë“±)
        avutil      # ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ë“¤
        swscale     # ì´ë¯¸ì§€ í¬ê¸° ë³€í™˜
        swresample  # ì˜¤ë””ì˜¤ ë¦¬ìƒ˜í”Œë§  
        avfilter    # ë¹„ë””ì˜¤/ì˜¤ë””ì˜¤ í•„í„°
    )
# macOS ARM64 (Apple Silicon) í™˜ê²½ ì„¤ì •  
elseif(APPLE AND CMAKE_SYSTEM_PROCESSOR STREQUAL "arm64")
    # Homebrew ARM64 ì„¤ì¹˜ ê²½ë¡œë¥¼ CMake íƒìƒ‰ ê²½ë¡œì— ì¶”ê°€
    set(CMAKE_PREFIX_PATH "/opt/homebrew" ${CMAKE_PREFIX_PATH})
    include_directories("/opt/homebrew/include")
    link_directories("/opt/homebrew/lib")
    
    # pkg-configë¥¼ ì‚¬ìš©í•˜ì—¬ FFmpeg ë¼ì´ë¸ŒëŸ¬ë¦¬ ìë™ íƒì§€
    find_package(PkgConfig REQUIRED)
    pkg_check_modules(FFMPEG REQUIRED 
        libavformat    # íŒŒì¼ í˜•ì‹ ì²˜ë¦¬
        libavcodec     # ì½”ë± ì²˜ë¦¬
        libavutil      # ìœ í‹¸ë¦¬í‹°
        libswscale     # ì´ë¯¸ì§€ ë³€í™˜
        libswresample  # ì˜¤ë””ì˜¤ ë¦¬ìƒ˜í”Œë§
        libavfilter    # í•„í„°
    )
    
    # FFmpeg ë¼ì´ë¸ŒëŸ¬ë¦¬ ëª©ë¡ì„ ë³€ìˆ˜ì— ì €ì¥
    set(FFMPEG_LIBRARIES ${FFMPEG_LIBRARIES})
    
# Linux ë˜ëŠ” ê¸°íƒ€ UNIX ê³„ì—´ ì‹œìŠ¤í…œ ì„¤ì •
else()
    # pkg-configë¥¼ ì‚¬ìš©í•˜ì—¬ ì‹œìŠ¤í…œì— ì„¤ì¹˜ëœ FFmpeg ë¼ì´ë¸ŒëŸ¬ë¦¬ íƒì§€
    find_package(PkgConfig REQUIRED)
    pkg_check_modules(FFMPEG REQUIRED 
        libavformat    # íŒŒì¼ í˜•ì‹ ì²˜ë¦¬
        libavcodec     # ì½”ë± ì²˜ë¦¬
        libavutil      # ìœ í‹¸ë¦¬í‹°
        libswscale     # ì´ë¯¸ì§€ ë³€í™˜
        libswresample  # ì˜¤ë””ì˜¤ ë¦¬ìƒ˜í”Œë§
        libavfilter    # í•„í„°
    )
    
    # FFmpeg ë¼ì´ë¸ŒëŸ¬ë¦¬ ëª©ë¡ì„ ë³€ìˆ˜ì— ì €ì¥
    set(FFMPEG_LIBRARIES ${FFMPEG_LIBRARIES})
endif()

# =============================================================================
# SDL2 ë¼ì´ë¸ŒëŸ¬ë¦¬ ì„¤ì • (GUI ë¹„ë””ì˜¤ í”Œë ˆì´ì–´ìš©, ì„ íƒì‚¬í•­)
# =============================================================================
# SDL2ê°€ ì‹œìŠ¤í…œì— ì„¤ì¹˜ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸
find_package(SDL2 QUIET)  # QUIET: ì°¾ì§€ ëª»í•´ë„ ì˜¤ë¥˜ ë©”ì‹œì§€ ì¶œë ¥ ì•ˆí•¨

# =============================================================================
# ì‹¤í–‰ íŒŒì¼ ìƒì„± ë° ë¼ì´ë¸ŒëŸ¬ë¦¬ ë§í¬ ì„¤ì •
# =============================================================================

# 1. FFmpeg ì •ë³´ ì¡°íšŒ ë„êµ¬
add_executable(ffmpeg-info src/ffmpeg_info.cpp)
target_link_libraries(ffmpeg-info ${FFMPEG_LIBRARIES})

# 2. ë¹„ë””ì˜¤ ë¶„ì„ ì˜ˆì œ
add_executable(video-analysis examples/video_analysis.cpp)
target_link_libraries(video-analysis ${FFMPEG_LIBRARIES})

# 3. í”„ë ˆì„ ì¶”ì¶œ ì˜ˆì œ
add_executable(frame-extract examples/frame_extraction.cpp)
target_link_libraries(frame-extract ${FFMPEG_LIBRARIES})

# 4. ê°„ë‹¨í•œ ì¸ì½”ë” ì˜ˆì œ
add_executable(simple-encoder examples/simple_encoder.cpp)
target_link_libraries(simple-encoder ${FFMPEG_LIBRARIES})

# =============================================================================
# ê³ ê¸‰ ì˜ˆì œë“¤ (Advanced Examples)
# =============================================================================

# 5. í•˜ë“œì›¨ì–´ ê°€ì† ë””ì½”ë” (Windowsì—ì„œëŠ” ì†Œí”„íŠ¸ì›¨ì–´ ë””ì½”ë”© ì‚¬ìš©)
add_executable(hardware-decoder examples/advanced/hardware_decoder.cpp)
target_link_libraries(hardware-decoder ${FFMPEG_LIBRARIES})

# 6. ê³ ê¸‰ ë¹„ë””ì˜¤ í•„í„° í”„ë¡œì„¸ì„œ
add_executable(video-filter examples/advanced/video_filter.cpp)
target_link_libraries(video-filter ${FFMPEG_LIBRARIES})

# 7. RTMP ë¼ì´ë¸Œ ìŠ¤íŠ¸ë¦¬ë¨¸
add_executable(rtmp-streamer examples/advanced/rtmp_streamer.cpp)
target_link_libraries(rtmp-streamer ${FFMPEG_LIBRARIES})

# 8. í•˜ë“œì›¨ì–´ ê°€ì† ë¹„ë””ì˜¤ í”Œë ˆì´ì–´
add_executable(video-player examples/advanced/video_player.cpp)
target_link_libraries(video-player ${FFMPEG_LIBRARIES})

# 9. GUI ë¹„ë””ì˜¤ í”Œë ˆì´ì–´ (SDL2 ê¸°ë°˜, ì¡°ê±´ë¶€ ë¹Œë“œ)
if(SDL2_FOUND)
    add_executable(gui-video-player examples/advanced/gui_video_player.cpp)
    target_link_libraries(gui-video-player ${FFMPEG_LIBRARIES} ${SDL2_LIBRARIES})
    message(STATUS "âœ… GUI ë¹„ë””ì˜¤ í”Œë ˆì´ì–´ê°€ ë¹Œë“œì— í¬í•¨ë©ë‹ˆë‹¤ (SDL2 ë°œê²¬)")
else()
    message(STATUS "âš ï¸  SDL2ë¥¼ ì°¾ì„ ìˆ˜ ì—†ì–´ GUI í”Œë ˆì´ì–´ê°€ ì œì™¸ë©ë‹ˆë‹¤.")
endif()

# =============================================================================
# ì»´íŒŒì¼ëŸ¬ ë””ë²„ê¹… ì„¤ì •
# =============================================================================
# ë””ë²„ê¹…ì„ ìœ„í•œ ì»´íŒŒì¼ëŸ¬ í”Œë˜ê·¸ ì„¤ì •

# ë¹Œë“œ íƒ€ì…ì„ Debugë¡œ ì„¤ì •
set(CMAKE_BUILD_TYPE Debug)

# ì»´íŒŒì¼ëŸ¬ë³„ ë””ë²„ê·¸ í”Œë˜ê·¸ ì„¤ì •
if(MSVC)
    # Microsoft Visual C++ ì»´íŒŒì¼ëŸ¬ìš© ì„¤ì •
    set(CMAKE_CXX_FLAGS_DEBUG "/Zi /Od")  # /Zi: ë””ë²„ê·¸ ì •ë³´, /Od: ìµœì í™” ë¹„í™œì„±í™”
else()
    # GCC/Clang ì»´íŒŒì¼ëŸ¬ìš© ì„¤ì •
    set(CMAKE_CXX_FLAGS_DEBUG "-g -O0")   # -g: ë””ë²„ê·¸ ì •ë³´, -O0: ìµœì í™” ë¹„í™œì„±í™”
endif()
